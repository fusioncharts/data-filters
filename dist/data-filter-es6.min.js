(function(window, document, undefined) {
"use strict";

class FCDataFilterExt {
  constructor (userconfig) {
    this.multiChart = new MultiCharting();
    this.datastore = this.multiChart.createDataStore();
    /**
    * User configuration format
    * {
    *   blockedCategories: ['Product'],
    *   disabledCategories: ['Product'],
    *   disabledItems: {
    *     'Product' : ['Tea']
    *   },
    *   range: {
    *     year: {min: 2000, max: 2010}
    *   }
    * }
    */
    this.userconfig = userconfig || {};
    // setting demo data
    this.demoData = {
      dataSource: [{
        product: 'tea',
        state: 'bengal',
        sale: '45',
        year: 1990
      },
      {
        product: 'coffee',
        sale: '90',
        state: 'orissa',
        year: 2016
      }]
    };
    this.datastore.setData(this.demoData);
    this.displayConfig = this.createMenuConfigFromData();
    this.filterVisual = new FilterVisual(this.displayConfig, 'filter-parent', this);
    // data set
  }

  generateBlockList (_list) {
    var list = _list || [],
      i = 0,
      ii = list.length,
      key,
      includeAll = false,
      blockList = [],
      item = {},
      itemListArr = [],
      j = 0,
      jj = 0,
      min = 0,
      max = 0,
      subItem = {};
    for (i = 0; i < ii; ++i) {
      item = list[i];
      includeAll = false;
      // if config was disabled or not visible; skip
      if (item.disabled || !item.visible) {
        continue;
      }
      if (!item.checked) {
        includeAll = true;
      }
      // Operation for type string
      if (item.type === 'string') {
        for (j = 0, jj = item.items.length; j < jj; ++j) {
          subItem = item.items[j];
          if (!subItem.disabled && (includeAll || !subItem.checked)) {
            if (blockList.indexOf(item.category + subItem.value) === -1) {
              blockList.push(item.category + subItem.value);
            } // end if
          } // end if
        } // end for j
      } // end if
      // operation for type number
      if (item.type === 'number') {
        for (j = 0, jj = item.items.length; j < jj; ++j) {
          subItem = item.items[j];
          min = item.range[0];
          max = item.range[1];
          if (includeAll || subItem.value < min || subItem.value > max) {
            if (blockList.indexOf(item.category + subItem.value) === -1) {
              blockList.push(item.category + subItem.value);
            } // end if
          } // end if
        } // end for j
      } // end if
    } // end for i
    return blockList;
  } // end function

  /**
  * function that will be called after
  * apply has been clicked in ui
  */
  apply (config) {
    console.log('Before change', JSON.stringify(this.datastore.getJSON(), null, 4));
    var dataprocessor = this.multiChart.createDataProcessor();
    dataprocessor.filter(this.createFilter(config));
    console.log('After change', JSON.stringify(this.datastore.getData(dataprocessor).getJSON(), null, 4));
  }

  createFilter (_config) {
    var config = _config || this.displayConfig,
      blockList = this.generateBlockList(config);
    return function (object, index, array) {
      var key;
      for (key in object) {
        if (blockList.indexOf(key + object[key]) !== -1) {
          return;
        }
      }
      return object;
    };
  }

  /**
  * Create config menu according to which
  * view will be rendered.
  */
  createMenuConfigFromData () {
    var config = [],
      datastore = this.datastore,
      key = '',
      temp = {},
      tempArr = {},
      type = '',
      keysArr = datastore.getKeys(),
      i = 0,
      ii = 0;
    if (!datastore) {
      return;
    }
    // Iterating over unique keys
    for (i = 0, ii = keysArr.length; i < ii; ++i) {
      key = keysArr[i];
      temp = {
        category: key,
        disabled: false,
        checked: true,
        visible: true,
        enableCheck: false
      };
      this.__createItemsList__(temp);
      this.__applyUserConfig__(temp);
      config.push(temp);
    }
    return config;
  }

  __createItemsList__ (object) {
    var datastore = this.datastore,
      category = object.category,
      valuesArr = datastore.getUniqueValues(category),
      type = this.__getType__(valuesArr),
      min = 0,
      max = 0,
      i = 0,
      ii = 0;
    // setting type
    object.type = type;
    if (type === 'string') {
      // string will have items list
      object.items = [];
      for (i = 0, ii = valuesArr.length; i < ii; ++i) {
        object.items.push({
          value: valuesArr[i],
          disabled: false,
          checked: true
        });
      }
    } else if (type === 'number') {
      // numbers will have range and a value list
      object.items = [];
      for (i = 0, ii = valuesArr.length; i < ii; ++i) {
        object.items.push({
          value: valuesArr[i]
        });
      }
      min = Math.min.apply(null, valuesArr);
      max = Math.max.apply(null, valuesArr);
      if (this.userconfig.range && this.userconfig.range[category]) {
        if (this.userconfig.range[category].min && this.userconfig.range[category].min > min) {
          min = this.userconfig.range[category].min;
        }
        if (this.userconfig.range[category].max && this.userconfig.range[category].max < max) {
          max = this.userconfig.range[category].max;
        }
      }
      object.range = [min, max];
    }
  }

  __applyUserConfig__ (object) {
    var userconfig = this.userconfig,
      type = object.type,
      category = object.category,
      blockedCategories = userconfig.blockedCategories,
      disabledCategories = userconfig.disabledCategories,
      disabledItems = userconfig.disabledItems && userconfig.disabledItems[category],
      items = object.items || [],
      i = 0,
      ii = items.length;

    if (Array.isArray(blockedCategories) && blockedCategories.indexOf(category) !== -1) {
      object.visible = false;
    }
    if (Array.isArray(disabledCategories) && disabledCategories.indexOf(category) !== -1) {
      object.disabled = true;
    }

    if (Array.isArray(disabledItems)) {
      for (; i < ii; ++i) {
        if (disabledItems.indexOf(items[i].value) !== -1) {
          object.items[i].disabled = true;
        }
      }
    }
  }

  __getType__ (arr) {
    let i = arr.length,
      type = {
        string: 'string',
        number: 'number'
      };
    while (i--) {
      if (isNaN(+arr[i])) {
        return type.string;
      }
    }
    return type.number;
  }
}
window.FCDataFilterExt = FCDataFilterExt;

'use strict';

class FilterVisual {

  constructor (filterState, containerId, filterExt) {
    /**
     * @private
     */
    this.filterState = filterState;
    this.filterExt = filterExt;
    this.config = {};
    this.config.containerId = containerId;
    this.draw();
  }

  draw () {
    var self = this,
      filterState = self.filterState,
      containerId = self.config.containerId,
      parentContainer = document.getElementById(containerId),
      wrapper,
      section,
      cards,
      header,
      input,
      label,
      cardBody,
      ul,
      li,
      i,
      j,
      catName,
      catObj,
      itemObj,
      itemVal,
      button;

    if (!parentContainer) {
      return;
    }

    parentContainer.innerHTML = '';

    wrapper = self.createElements('div', {
      'class': 'fc_ext_filter_cont'
    });
    wrapper.setAttribute('style', 'overflow-y: scroll; overflow-x: hidden;');
    wrapper.style.height = parentContainer.style.height;

    for (i = 0; i < filterState.length; i++) {
      catObj = filterState[i];
      catName = catObj.category;

      if (catObj.visible) {
        section = self.createElements('section');
        wrapper.appendChild(section);

        cards = self.createElements('div', {
          'class': 'fc_ext_filter_card'
        });
        section.appendChild(cards);

        header = self.createElements('header');
        cards.appendChild(header);

        input = self.createElements('input', {
          'type': 'checkbox',
          'value': catName,
          'id': 'fc_ext_filter_cat_' + catName,
          'checked': catObj.checked
        });
        catObj.elem = input;
        input.disabled = catObj.disabled;
        header.appendChild(input);

        label = self.createElements('label', {
          'for': 'fc_ext_filter_cat_' + catName
        });
        label.innerHTML = catName.toUpperCase();
        header.appendChild(label);

        cardBody = self.createElements('div', {
          'class': 'fc_ext_filter_card-body'
        });
        cards.appendChild(cardBody);

        if (catObj.type === 'string') {
          ul = self.createElements('ul');
          cardBody.appendChild(ul);

          for (j = 0; j < catObj.items.length; j++) {
            itemObj = catObj.items[j];
            itemVal = itemObj.value;

            li = self.createElements('li');
            ul.appendChild(li);

            input = self.createElements('input', {
              'type': 'checkbox',
              'value': itemVal,
              'id': 'fc_ext_filter_item_' + itemVal,
              'checked': itemObj.checked
            });
            itemObj.elem = input;
            input.disabled = itemObj.disabled;
            li.appendChild(input);
            label = self.createElements('label', {
              'for': 'fc_ext_filter_item_' + itemVal
            });
            label.innerHTML = itemVal.toUpperCase();
            li.appendChild(label);
          }
        }
      }
    }
    section = self.createElements('section');
    wrapper.appendChild(section);
    button = self.createElements('button');
    button.innerHTML = 'Apply';
    button.onclick = self.applyFilter.bind(this);
    section.appendChild(button);

    parentContainer.appendChild(wrapper);
    window.filterState = filterState;
  }

  applyFilter () {
    var self = this,
      filterState = self.filterState,
      i,
      j,
      catObj,
      itemObj,
      catElem,
      itemElem;

    for (i = 0; i < filterState.length; i++) {
      catObj = filterState[i];
      catElem = catObj.elem;

      if (catObj.type === 'string') {
        if (catElem && !catObj.disabled) {
          catObj.checked = catElem.checked;
        }
        for (j = 0; j < catObj.items.length; j++) {
          itemObj = catObj.items[j];
          itemElem = itemObj.elem;
          if (itemElem && !itemObj.disabled) {
            itemObj.checked = itemElem.checked;
          }
        }
      }
    }
    self.filterExt.apply(filterState);
  }

  createElements (name, attr) {
    var elem = document.createElement(name),
      key;

    for (key in attr) {
      elem.setAttribute(key, attr[key]);
    }

    return elem;
  }
}
}(this, document));

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJkYXRhLWZpbHRlci1lczYubWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpIHtcblwidXNlIHN0cmljdFwiO1xuXG5jbGFzcyBGQ0RhdGFGaWx0ZXJFeHQge1xuICBjb25zdHJ1Y3RvciAodXNlcmNvbmZpZykge1xuICAgIHRoaXMubXVsdGlDaGFydCA9IG5ldyBNdWx0aUNoYXJ0aW5nKCk7XG4gICAgdGhpcy5kYXRhc3RvcmUgPSB0aGlzLm11bHRpQ2hhcnQuY3JlYXRlRGF0YVN0b3JlKCk7XG4gICAgLyoqXG4gICAgKiBVc2VyIGNvbmZpZ3VyYXRpb24gZm9ybWF0XG4gICAgKiB7XG4gICAgKiAgIGJsb2NrZWRDYXRlZ29yaWVzOiBbJ1Byb2R1Y3QnXSxcbiAgICAqICAgZGlzYWJsZWRDYXRlZ29yaWVzOiBbJ1Byb2R1Y3QnXSxcbiAgICAqICAgZGlzYWJsZWRJdGVtczoge1xuICAgICogICAgICdQcm9kdWN0JyA6IFsnVGVhJ11cbiAgICAqICAgfSxcbiAgICAqICAgcmFuZ2U6IHtcbiAgICAqICAgICB5ZWFyOiB7bWluOiAyMDAwLCBtYXg6IDIwMTB9XG4gICAgKiAgIH1cbiAgICAqIH1cbiAgICAqL1xuICAgIHRoaXMudXNlcmNvbmZpZyA9IHVzZXJjb25maWcgfHwge307XG4gICAgLy8gc2V0dGluZyBkZW1vIGRhdGFcbiAgICB0aGlzLmRlbW9EYXRhID0ge1xuICAgICAgZGF0YVNvdXJjZTogW3tcbiAgICAgICAgcHJvZHVjdDogJ3RlYScsXG4gICAgICAgIHN0YXRlOiAnYmVuZ2FsJyxcbiAgICAgICAgc2FsZTogJzQ1JyxcbiAgICAgICAgeWVhcjogMTk5MFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcHJvZHVjdDogJ2NvZmZlZScsXG4gICAgICAgIHNhbGU6ICc5MCcsXG4gICAgICAgIHN0YXRlOiAnb3Jpc3NhJyxcbiAgICAgICAgeWVhcjogMjAxNlxuICAgICAgfV1cbiAgICB9O1xuICAgIHRoaXMuZGF0YXN0b3JlLnNldERhdGEodGhpcy5kZW1vRGF0YSk7XG4gICAgdGhpcy5kaXNwbGF5Q29uZmlnID0gdGhpcy5jcmVhdGVNZW51Q29uZmlnRnJvbURhdGEoKTtcbiAgICB0aGlzLmZpbHRlclZpc3VhbCA9IG5ldyBGaWx0ZXJWaXN1YWwodGhpcy5kaXNwbGF5Q29uZmlnLCAnZmlsdGVyLXBhcmVudCcsIHRoaXMpO1xuICAgIC8vIGRhdGEgc2V0XG4gIH1cblxuICBnZW5lcmF0ZUJsb2NrTGlzdCAoX2xpc3QpIHtcbiAgICB2YXIgbGlzdCA9IF9saXN0IHx8IFtdLFxuICAgICAgaSA9IDAsXG4gICAgICBpaSA9IGxpc3QubGVuZ3RoLFxuICAgICAga2V5LFxuICAgICAgaW5jbHVkZUFsbCA9IGZhbHNlLFxuICAgICAgYmxvY2tMaXN0ID0gW10sXG4gICAgICBpdGVtID0ge30sXG4gICAgICBpdGVtTGlzdEFyciA9IFtdLFxuICAgICAgaiA9IDAsXG4gICAgICBqaiA9IDAsXG4gICAgICBtaW4gPSAwLFxuICAgICAgbWF4ID0gMCxcbiAgICAgIHN1Ykl0ZW0gPSB7fTtcbiAgICBmb3IgKGkgPSAwOyBpIDwgaWk7ICsraSkge1xuICAgICAgaXRlbSA9IGxpc3RbaV07XG4gICAgICBpbmNsdWRlQWxsID0gZmFsc2U7XG4gICAgICAvLyBpZiBjb25maWcgd2FzIGRpc2FibGVkIG9yIG5vdCB2aXNpYmxlOyBza2lwXG4gICAgICBpZiAoaXRlbS5kaXNhYmxlZCB8fCAhaXRlbS52aXNpYmxlKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKCFpdGVtLmNoZWNrZWQpIHtcbiAgICAgICAgaW5jbHVkZUFsbCA9IHRydWU7XG4gICAgICB9XG4gICAgICAvLyBPcGVyYXRpb24gZm9yIHR5cGUgc3RyaW5nXG4gICAgICBpZiAoaXRlbS50eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICBmb3IgKGogPSAwLCBqaiA9IGl0ZW0uaXRlbXMubGVuZ3RoOyBqIDwgamo7ICsraikge1xuICAgICAgICAgIHN1Ykl0ZW0gPSBpdGVtLml0ZW1zW2pdO1xuICAgICAgICAgIGlmICghc3ViSXRlbS5kaXNhYmxlZCAmJiAoaW5jbHVkZUFsbCB8fCAhc3ViSXRlbS5jaGVja2VkKSkge1xuICAgICAgICAgICAgaWYgKGJsb2NrTGlzdC5pbmRleE9mKGl0ZW0uY2F0ZWdvcnkgKyBzdWJJdGVtLnZhbHVlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgYmxvY2tMaXN0LnB1c2goaXRlbS5jYXRlZ29yeSArIHN1Ykl0ZW0udmFsdWUpO1xuICAgICAgICAgICAgfSAvLyBlbmQgaWZcbiAgICAgICAgICB9IC8vIGVuZCBpZlxuICAgICAgICB9IC8vIGVuZCBmb3IgalxuICAgICAgfSAvLyBlbmQgaWZcbiAgICAgIC8vIG9wZXJhdGlvbiBmb3IgdHlwZSBudW1iZXJcbiAgICAgIGlmIChpdGVtLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIGZvciAoaiA9IDAsIGpqID0gaXRlbS5pdGVtcy5sZW5ndGg7IGogPCBqajsgKytqKSB7XG4gICAgICAgICAgc3ViSXRlbSA9IGl0ZW0uaXRlbXNbal07XG4gICAgICAgICAgbWluID0gaXRlbS5yYW5nZVswXTtcbiAgICAgICAgICBtYXggPSBpdGVtLnJhbmdlWzFdO1xuICAgICAgICAgIGlmIChpbmNsdWRlQWxsIHx8IHN1Ykl0ZW0udmFsdWUgPCBtaW4gfHwgc3ViSXRlbS52YWx1ZSA+IG1heCkge1xuICAgICAgICAgICAgaWYgKGJsb2NrTGlzdC5pbmRleE9mKGl0ZW0uY2F0ZWdvcnkgKyBzdWJJdGVtLnZhbHVlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgYmxvY2tMaXN0LnB1c2goaXRlbS5jYXRlZ29yeSArIHN1Ykl0ZW0udmFsdWUpO1xuICAgICAgICAgICAgfSAvLyBlbmQgaWZcbiAgICAgICAgICB9IC8vIGVuZCBpZlxuICAgICAgICB9IC8vIGVuZCBmb3IgalxuICAgICAgfSAvLyBlbmQgaWZcbiAgICB9IC8vIGVuZCBmb3IgaVxuICAgIHJldHVybiBibG9ja0xpc3Q7XG4gIH0gLy8gZW5kIGZ1bmN0aW9uXG5cbiAgLyoqXG4gICogZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBhZnRlclxuICAqIGFwcGx5IGhhcyBiZWVuIGNsaWNrZWQgaW4gdWlcbiAgKi9cbiAgYXBwbHkgKGNvbmZpZykge1xuICAgIGNvbnNvbGUubG9nKCdCZWZvcmUgY2hhbmdlJywgSlNPTi5zdHJpbmdpZnkodGhpcy5kYXRhc3RvcmUuZ2V0SlNPTigpLCBudWxsLCA0KSk7XG4gICAgdmFyIGRhdGFwcm9jZXNzb3IgPSB0aGlzLm11bHRpQ2hhcnQuY3JlYXRlRGF0YVByb2Nlc3NvcigpO1xuICAgIGRhdGFwcm9jZXNzb3IuZmlsdGVyKHRoaXMuY3JlYXRlRmlsdGVyKGNvbmZpZykpO1xuICAgIGNvbnNvbGUubG9nKCdBZnRlciBjaGFuZ2UnLCBKU09OLnN0cmluZ2lmeSh0aGlzLmRhdGFzdG9yZS5nZXREYXRhKGRhdGFwcm9jZXNzb3IpLmdldEpTT04oKSwgbnVsbCwgNCkpO1xuICB9XG5cbiAgY3JlYXRlRmlsdGVyIChfY29uZmlnKSB7XG4gICAgdmFyIGNvbmZpZyA9IF9jb25maWcgfHwgdGhpcy5kaXNwbGF5Q29uZmlnLFxuICAgICAgYmxvY2tMaXN0ID0gdGhpcy5nZW5lcmF0ZUJsb2NrTGlzdChjb25maWcpO1xuICAgIHJldHVybiBmdW5jdGlvbiAob2JqZWN0LCBpbmRleCwgYXJyYXkpIHtcbiAgICAgIHZhciBrZXk7XG4gICAgICBmb3IgKGtleSBpbiBvYmplY3QpIHtcbiAgICAgICAgaWYgKGJsb2NrTGlzdC5pbmRleE9mKGtleSArIG9iamVjdFtrZXldKSAhPT0gLTEpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBvYmplY3Q7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAqIENyZWF0ZSBjb25maWcgbWVudSBhY2NvcmRpbmcgdG8gd2hpY2hcbiAgKiB2aWV3IHdpbGwgYmUgcmVuZGVyZWQuXG4gICovXG4gIGNyZWF0ZU1lbnVDb25maWdGcm9tRGF0YSAoKSB7XG4gICAgdmFyIGNvbmZpZyA9IFtdLFxuICAgICAgZGF0YXN0b3JlID0gdGhpcy5kYXRhc3RvcmUsXG4gICAgICBrZXkgPSAnJyxcbiAgICAgIHRlbXAgPSB7fSxcbiAgICAgIHRlbXBBcnIgPSB7fSxcbiAgICAgIHR5cGUgPSAnJyxcbiAgICAgIGtleXNBcnIgPSBkYXRhc3RvcmUuZ2V0S2V5cygpLFxuICAgICAgaSA9IDAsXG4gICAgICBpaSA9IDA7XG4gICAgaWYgKCFkYXRhc3RvcmUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gSXRlcmF0aW5nIG92ZXIgdW5pcXVlIGtleXNcbiAgICBmb3IgKGkgPSAwLCBpaSA9IGtleXNBcnIubGVuZ3RoOyBpIDwgaWk7ICsraSkge1xuICAgICAga2V5ID0ga2V5c0FycltpXTtcbiAgICAgIHRlbXAgPSB7XG4gICAgICAgIGNhdGVnb3J5OiBrZXksXG4gICAgICAgIGRpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgY2hlY2tlZDogdHJ1ZSxcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgZW5hYmxlQ2hlY2s6IGZhbHNlXG4gICAgICB9O1xuICAgICAgdGhpcy5fX2NyZWF0ZUl0ZW1zTGlzdF9fKHRlbXApO1xuICAgICAgdGhpcy5fX2FwcGx5VXNlckNvbmZpZ19fKHRlbXApO1xuICAgICAgY29uZmlnLnB1c2godGVtcCk7XG4gICAgfVxuICAgIHJldHVybiBjb25maWc7XG4gIH1cblxuICBfX2NyZWF0ZUl0ZW1zTGlzdF9fIChvYmplY3QpIHtcbiAgICB2YXIgZGF0YXN0b3JlID0gdGhpcy5kYXRhc3RvcmUsXG4gICAgICBjYXRlZ29yeSA9IG9iamVjdC5jYXRlZ29yeSxcbiAgICAgIHZhbHVlc0FyciA9IGRhdGFzdG9yZS5nZXRVbmlxdWVWYWx1ZXMoY2F0ZWdvcnkpLFxuICAgICAgdHlwZSA9IHRoaXMuX19nZXRUeXBlX18odmFsdWVzQXJyKSxcbiAgICAgIG1pbiA9IDAsXG4gICAgICBtYXggPSAwLFxuICAgICAgaSA9IDAsXG4gICAgICBpaSA9IDA7XG4gICAgLy8gc2V0dGluZyB0eXBlXG4gICAgb2JqZWN0LnR5cGUgPSB0eXBlO1xuICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgLy8gc3RyaW5nIHdpbGwgaGF2ZSBpdGVtcyBsaXN0XG4gICAgICBvYmplY3QuaXRlbXMgPSBbXTtcbiAgICAgIGZvciAoaSA9IDAsIGlpID0gdmFsdWVzQXJyLmxlbmd0aDsgaSA8IGlpOyArK2kpIHtcbiAgICAgICAgb2JqZWN0Lml0ZW1zLnB1c2goe1xuICAgICAgICAgIHZhbHVlOiB2YWx1ZXNBcnJbaV0sXG4gICAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgIGNoZWNrZWQ6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgLy8gbnVtYmVycyB3aWxsIGhhdmUgcmFuZ2UgYW5kIGEgdmFsdWUgbGlzdFxuICAgICAgb2JqZWN0Lml0ZW1zID0gW107XG4gICAgICBmb3IgKGkgPSAwLCBpaSA9IHZhbHVlc0Fyci5sZW5ndGg7IGkgPCBpaTsgKytpKSB7XG4gICAgICAgIG9iamVjdC5pdGVtcy5wdXNoKHtcbiAgICAgICAgICB2YWx1ZTogdmFsdWVzQXJyW2ldXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgbWluID0gTWF0aC5taW4uYXBwbHkobnVsbCwgdmFsdWVzQXJyKTtcbiAgICAgIG1heCA9IE1hdGgubWF4LmFwcGx5KG51bGwsIHZhbHVlc0Fycik7XG4gICAgICBpZiAodGhpcy51c2VyY29uZmlnLnJhbmdlICYmIHRoaXMudXNlcmNvbmZpZy5yYW5nZVtjYXRlZ29yeV0pIHtcbiAgICAgICAgaWYgKHRoaXMudXNlcmNvbmZpZy5yYW5nZVtjYXRlZ29yeV0ubWluICYmIHRoaXMudXNlcmNvbmZpZy5yYW5nZVtjYXRlZ29yeV0ubWluID4gbWluKSB7XG4gICAgICAgICAgbWluID0gdGhpcy51c2VyY29uZmlnLnJhbmdlW2NhdGVnb3J5XS5taW47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudXNlcmNvbmZpZy5yYW5nZVtjYXRlZ29yeV0ubWF4ICYmIHRoaXMudXNlcmNvbmZpZy5yYW5nZVtjYXRlZ29yeV0ubWF4IDwgbWF4KSB7XG4gICAgICAgICAgbWF4ID0gdGhpcy51c2VyY29uZmlnLnJhbmdlW2NhdGVnb3J5XS5tYXg7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG9iamVjdC5yYW5nZSA9IFttaW4sIG1heF07XG4gICAgfVxuICB9XG5cbiAgX19hcHBseVVzZXJDb25maWdfXyAob2JqZWN0KSB7XG4gICAgdmFyIHVzZXJjb25maWcgPSB0aGlzLnVzZXJjb25maWcsXG4gICAgICB0eXBlID0gb2JqZWN0LnR5cGUsXG4gICAgICBjYXRlZ29yeSA9IG9iamVjdC5jYXRlZ29yeSxcbiAgICAgIGJsb2NrZWRDYXRlZ29yaWVzID0gdXNlcmNvbmZpZy5ibG9ja2VkQ2F0ZWdvcmllcyxcbiAgICAgIGRpc2FibGVkQ2F0ZWdvcmllcyA9IHVzZXJjb25maWcuZGlzYWJsZWRDYXRlZ29yaWVzLFxuICAgICAgZGlzYWJsZWRJdGVtcyA9IHVzZXJjb25maWcuZGlzYWJsZWRJdGVtcyAmJiB1c2VyY29uZmlnLmRpc2FibGVkSXRlbXNbY2F0ZWdvcnldLFxuICAgICAgaXRlbXMgPSBvYmplY3QuaXRlbXMgfHwgW10sXG4gICAgICBpID0gMCxcbiAgICAgIGlpID0gaXRlbXMubGVuZ3RoO1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoYmxvY2tlZENhdGVnb3JpZXMpICYmIGJsb2NrZWRDYXRlZ29yaWVzLmluZGV4T2YoY2F0ZWdvcnkpICE9PSAtMSkge1xuICAgICAgb2JqZWN0LnZpc2libGUgPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZGlzYWJsZWRDYXRlZ29yaWVzKSAmJiBkaXNhYmxlZENhdGVnb3JpZXMuaW5kZXhPZihjYXRlZ29yeSkgIT09IC0xKSB7XG4gICAgICBvYmplY3QuZGlzYWJsZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KGRpc2FibGVkSXRlbXMpKSB7XG4gICAgICBmb3IgKDsgaSA8IGlpOyArK2kpIHtcbiAgICAgICAgaWYgKGRpc2FibGVkSXRlbXMuaW5kZXhPZihpdGVtc1tpXS52YWx1ZSkgIT09IC0xKSB7XG4gICAgICAgICAgb2JqZWN0Lml0ZW1zW2ldLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIF9fZ2V0VHlwZV9fIChhcnIpIHtcbiAgICBsZXQgaSA9IGFyci5sZW5ndGgsXG4gICAgICB0eXBlID0ge1xuICAgICAgICBzdHJpbmc6ICdzdHJpbmcnLFxuICAgICAgICBudW1iZXI6ICdudW1iZXInXG4gICAgICB9O1xuICAgIHdoaWxlIChpLS0pIHtcbiAgICAgIGlmIChpc05hTigrYXJyW2ldKSkge1xuICAgICAgICByZXR1cm4gdHlwZS5zdHJpbmc7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0eXBlLm51bWJlcjtcbiAgfVxufVxud2luZG93LkZDRGF0YUZpbHRlckV4dCA9IEZDRGF0YUZpbHRlckV4dDtcblxuJ3VzZSBzdHJpY3QnO1xuXG5jbGFzcyBGaWx0ZXJWaXN1YWwge1xuXG4gIGNvbnN0cnVjdG9yIChmaWx0ZXJTdGF0ZSwgY29udGFpbmVySWQsIGZpbHRlckV4dCkge1xuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgdGhpcy5maWx0ZXJTdGF0ZSA9IGZpbHRlclN0YXRlO1xuICAgIHRoaXMuZmlsdGVyRXh0ID0gZmlsdGVyRXh0O1xuICAgIHRoaXMuY29uZmlnID0ge307XG4gICAgdGhpcy5jb25maWcuY29udGFpbmVySWQgPSBjb250YWluZXJJZDtcbiAgICB0aGlzLmRyYXcoKTtcbiAgfVxuXG4gIGRyYXcgKCkge1xuICAgIHZhciBzZWxmID0gdGhpcyxcbiAgICAgIGZpbHRlclN0YXRlID0gc2VsZi5maWx0ZXJTdGF0ZSxcbiAgICAgIGNvbnRhaW5lcklkID0gc2VsZi5jb25maWcuY29udGFpbmVySWQsXG4gICAgICBwYXJlbnRDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb250YWluZXJJZCksXG4gICAgICB3cmFwcGVyLFxuICAgICAgc2VjdGlvbixcbiAgICAgIGNhcmRzLFxuICAgICAgaGVhZGVyLFxuICAgICAgaW5wdXQsXG4gICAgICBsYWJlbCxcbiAgICAgIGNhcmRCb2R5LFxuICAgICAgdWwsXG4gICAgICBsaSxcbiAgICAgIGksXG4gICAgICBqLFxuICAgICAgY2F0TmFtZSxcbiAgICAgIGNhdE9iaixcbiAgICAgIGl0ZW1PYmosXG4gICAgICBpdGVtVmFsLFxuICAgICAgYnV0dG9uO1xuXG4gICAgaWYgKCFwYXJlbnRDb250YWluZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwYXJlbnRDb250YWluZXIuaW5uZXJIVE1MID0gJyc7XG5cbiAgICB3cmFwcGVyID0gc2VsZi5jcmVhdGVFbGVtZW50cygnZGl2Jywge1xuICAgICAgJ2NsYXNzJzogJ2ZjX2V4dF9maWx0ZXJfY29udCdcbiAgICB9KTtcbiAgICB3cmFwcGVyLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCAnb3ZlcmZsb3cteTogc2Nyb2xsOyBvdmVyZmxvdy14OiBoaWRkZW47Jyk7XG4gICAgd3JhcHBlci5zdHlsZS5oZWlnaHQgPSBwYXJlbnRDb250YWluZXIuc3R5bGUuaGVpZ2h0O1xuXG4gICAgZm9yIChpID0gMDsgaSA8IGZpbHRlclN0YXRlLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjYXRPYmogPSBmaWx0ZXJTdGF0ZVtpXTtcbiAgICAgIGNhdE5hbWUgPSBjYXRPYmouY2F0ZWdvcnk7XG5cbiAgICAgIGlmIChjYXRPYmoudmlzaWJsZSkge1xuICAgICAgICBzZWN0aW9uID0gc2VsZi5jcmVhdGVFbGVtZW50cygnc2VjdGlvbicpO1xuICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKHNlY3Rpb24pO1xuXG4gICAgICAgIGNhcmRzID0gc2VsZi5jcmVhdGVFbGVtZW50cygnZGl2Jywge1xuICAgICAgICAgICdjbGFzcyc6ICdmY19leHRfZmlsdGVyX2NhcmQnXG4gICAgICAgIH0pO1xuICAgICAgICBzZWN0aW9uLmFwcGVuZENoaWxkKGNhcmRzKTtcblxuICAgICAgICBoZWFkZXIgPSBzZWxmLmNyZWF0ZUVsZW1lbnRzKCdoZWFkZXInKTtcbiAgICAgICAgY2FyZHMuYXBwZW5kQ2hpbGQoaGVhZGVyKTtcblxuICAgICAgICBpbnB1dCA9IHNlbGYuY3JlYXRlRWxlbWVudHMoJ2lucHV0Jywge1xuICAgICAgICAgICd0eXBlJzogJ2NoZWNrYm94JyxcbiAgICAgICAgICAndmFsdWUnOiBjYXROYW1lLFxuICAgICAgICAgICdpZCc6ICdmY19leHRfZmlsdGVyX2NhdF8nICsgY2F0TmFtZSxcbiAgICAgICAgICAnY2hlY2tlZCc6IGNhdE9iai5jaGVja2VkXG4gICAgICAgIH0pO1xuICAgICAgICBjYXRPYmouZWxlbSA9IGlucHV0O1xuICAgICAgICBpbnB1dC5kaXNhYmxlZCA9IGNhdE9iai5kaXNhYmxlZDtcbiAgICAgICAgaGVhZGVyLmFwcGVuZENoaWxkKGlucHV0KTtcblxuICAgICAgICBsYWJlbCA9IHNlbGYuY3JlYXRlRWxlbWVudHMoJ2xhYmVsJywge1xuICAgICAgICAgICdmb3InOiAnZmNfZXh0X2ZpbHRlcl9jYXRfJyArIGNhdE5hbWVcbiAgICAgICAgfSk7XG4gICAgICAgIGxhYmVsLmlubmVySFRNTCA9IGNhdE5hbWUudG9VcHBlckNhc2UoKTtcbiAgICAgICAgaGVhZGVyLmFwcGVuZENoaWxkKGxhYmVsKTtcblxuICAgICAgICBjYXJkQm9keSA9IHNlbGYuY3JlYXRlRWxlbWVudHMoJ2RpdicsIHtcbiAgICAgICAgICAnY2xhc3MnOiAnZmNfZXh0X2ZpbHRlcl9jYXJkLWJvZHknXG4gICAgICAgIH0pO1xuICAgICAgICBjYXJkcy5hcHBlbmRDaGlsZChjYXJkQm9keSk7XG5cbiAgICAgICAgaWYgKGNhdE9iai50eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHVsID0gc2VsZi5jcmVhdGVFbGVtZW50cygndWwnKTtcbiAgICAgICAgICBjYXJkQm9keS5hcHBlbmRDaGlsZCh1bCk7XG5cbiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgY2F0T2JqLml0ZW1zLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICBpdGVtT2JqID0gY2F0T2JqLml0ZW1zW2pdO1xuICAgICAgICAgICAgaXRlbVZhbCA9IGl0ZW1PYmoudmFsdWU7XG5cbiAgICAgICAgICAgIGxpID0gc2VsZi5jcmVhdGVFbGVtZW50cygnbGknKTtcbiAgICAgICAgICAgIHVsLmFwcGVuZENoaWxkKGxpKTtcblxuICAgICAgICAgICAgaW5wdXQgPSBzZWxmLmNyZWF0ZUVsZW1lbnRzKCdpbnB1dCcsIHtcbiAgICAgICAgICAgICAgJ3R5cGUnOiAnY2hlY2tib3gnLFxuICAgICAgICAgICAgICAndmFsdWUnOiBpdGVtVmFsLFxuICAgICAgICAgICAgICAnaWQnOiAnZmNfZXh0X2ZpbHRlcl9pdGVtXycgKyBpdGVtVmFsLFxuICAgICAgICAgICAgICAnY2hlY2tlZCc6IGl0ZW1PYmouY2hlY2tlZFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpdGVtT2JqLmVsZW0gPSBpbnB1dDtcbiAgICAgICAgICAgIGlucHV0LmRpc2FibGVkID0gaXRlbU9iai5kaXNhYmxlZDtcbiAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKGlucHV0KTtcbiAgICAgICAgICAgIGxhYmVsID0gc2VsZi5jcmVhdGVFbGVtZW50cygnbGFiZWwnLCB7XG4gICAgICAgICAgICAgICdmb3InOiAnZmNfZXh0X2ZpbHRlcl9pdGVtXycgKyBpdGVtVmFsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGxhYmVsLmlubmVySFRNTCA9IGl0ZW1WYWwudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKGxhYmVsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgc2VjdGlvbiA9IHNlbGYuY3JlYXRlRWxlbWVudHMoJ3NlY3Rpb24nKTtcbiAgICB3cmFwcGVyLmFwcGVuZENoaWxkKHNlY3Rpb24pO1xuICAgIGJ1dHRvbiA9IHNlbGYuY3JlYXRlRWxlbWVudHMoJ2J1dHRvbicpO1xuICAgIGJ1dHRvbi5pbm5lckhUTUwgPSAnQXBwbHknO1xuICAgIGJ1dHRvbi5vbmNsaWNrID0gc2VsZi5hcHBseUZpbHRlci5iaW5kKHRoaXMpO1xuICAgIHNlY3Rpb24uYXBwZW5kQ2hpbGQoYnV0dG9uKTtcblxuICAgIHBhcmVudENvbnRhaW5lci5hcHBlbmRDaGlsZCh3cmFwcGVyKTtcbiAgICB3aW5kb3cuZmlsdGVyU3RhdGUgPSBmaWx0ZXJTdGF0ZTtcbiAgfVxuXG4gIGFwcGx5RmlsdGVyICgpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXMsXG4gICAgICBmaWx0ZXJTdGF0ZSA9IHNlbGYuZmlsdGVyU3RhdGUsXG4gICAgICBpLFxuICAgICAgaixcbiAgICAgIGNhdE9iaixcbiAgICAgIGl0ZW1PYmosXG4gICAgICBjYXRFbGVtLFxuICAgICAgaXRlbUVsZW07XG5cbiAgICBmb3IgKGkgPSAwOyBpIDwgZmlsdGVyU3RhdGUubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNhdE9iaiA9IGZpbHRlclN0YXRlW2ldO1xuICAgICAgY2F0RWxlbSA9IGNhdE9iai5lbGVtO1xuXG4gICAgICBpZiAoY2F0T2JqLnR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGlmIChjYXRFbGVtICYmICFjYXRPYmouZGlzYWJsZWQpIHtcbiAgICAgICAgICBjYXRPYmouY2hlY2tlZCA9IGNhdEVsZW0uY2hlY2tlZDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGogPSAwOyBqIDwgY2F0T2JqLml0ZW1zLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgaXRlbU9iaiA9IGNhdE9iai5pdGVtc1tqXTtcbiAgICAgICAgICBpdGVtRWxlbSA9IGl0ZW1PYmouZWxlbTtcbiAgICAgICAgICBpZiAoaXRlbUVsZW0gJiYgIWl0ZW1PYmouZGlzYWJsZWQpIHtcbiAgICAgICAgICAgIGl0ZW1PYmouY2hlY2tlZCA9IGl0ZW1FbGVtLmNoZWNrZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHNlbGYuZmlsdGVyRXh0LmFwcGx5KGZpbHRlclN0YXRlKTtcbiAgfVxuXG4gIGNyZWF0ZUVsZW1lbnRzIChuYW1lLCBhdHRyKSB7XG4gICAgdmFyIGVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG5hbWUpLFxuICAgICAga2V5O1xuXG4gICAgZm9yIChrZXkgaW4gYXR0cikge1xuICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoa2V5LCBhdHRyW2tleV0pO1xuICAgIH1cblxuICAgIHJldHVybiBlbGVtO1xuICB9XG59XG59KHRoaXMsIGRvY3VtZW50KSk7XG4iXSwiZmlsZSI6ImRhdGEtZmlsdGVyLWVzNi5taW4uanMifQ==
